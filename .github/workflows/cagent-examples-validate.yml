name: cagent-examples-validate

on:
  pull_request:
    paths:
      - 'cagent/examples/**'
  workflow_dispatch: {}

jobs:
  validate:
    name: Validate examples YAML & safety
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install linter
        run: |
          python -m pip install --upgrade pip
          pip install yamllint pyyaml

      - name: Run yamllint
        run: |
          yamllint -c '{extends: default, rules: {line-length: {max: 200}}}' cagent/examples || true

      - name: YAML safety checks (dry_run & max_iterations)
        run: |
          python - <<'PY'
import glob, yaml, sys
files = glob.glob('cagent/examples/**/*.yaml', recursive=True) + glob.glob('cagent/examples/*.yaml')
if not files:
    print('No example YAMLs found')
    sys.exit(1)
failed = False
for f in sorted(files):
    try:
        with open(f) as fh:
            data = yaml.safe_load(fh)
    except Exception as e:
        print(f'ERROR: YAML parse error in {f}: {e}')
        failed = True
        continue
    def find_key(obj, key):
        if isinstance(obj, dict):
            if key in obj:
                return obj[key]
            for v in obj.values():
                res = find_key(v, key)
                if res is not None:
                    return res
        elif isinstance(obj, list):
            for i in obj:
                res = find_key(i, key)
                if res is not None:
                    return res
        return None
    dry = find_key(data, 'dry_run')
    if dry is None:
        print(f'NOTE: {f} does not explicitly set "dry_run"; recommend adding "dry_run: true" for safety')
    elif dry is not True:
        print(f'ERROR: {f} sets dry_run={dry} (expected true)')
        failed = True
    mi = find_key(data, 'max_iterations')
    if mi is not None:
        try:
            mi_int = int(mi)
            if mi_int > 10:
                print(f'ERROR: {f} max_iterations={mi_int} > 10')
                failed = True
        except Exception:
            print(f'ERROR: {f} has non-integer max_iterations: {mi}')
            failed = True
if failed:
    print('\nValidation failed')
    sys.exit(1)
print('\nValidation passed')
PY