name: vLLM Docker Compose Check (Lightweight)

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  compose-check:
    name: Docker Compose syntax & basic sanity check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Discover docker-compose files
        run: |
          files=$(git ls-files '*docker-compose.yml' || true)
          if [ -z "$files" ]; then
            echo "No docker-compose.yml files found in repository"; exit 1
          fi
          echo "Found compose files: $files"
          echo "$files" > /tmp/compose_files.txt

      - name: Validate docker-compose files and check ports
        run: |
          # Provide default env values to avoid config-time failures for unset variables
          export OPENAI_API_KEY=""
          export ANTHROPIC_API_KEY=""
          export GEMINI_API_KEY=""
          export VLLM_HOST_PORT=8001

          found_port=0
          while read -r f; do
            echo "Checking $f"
            docker compose -f "$f" config || {
              echo "docker compose config failed for $f"; docker compose -f "$f" config || true; exit 1
            }
            echo "Services in $f:"; docker compose -f "$f" config --services || true
            if docker compose -f "$f" config | grep -q "ports:"; then
              echo "Ports found in $f"
              found_port=1
            else
              echo "No ports found in $f"
            fi
          done < /tmp/compose_files.txt
          if [ "$found_port" -ne 1 ]; then
            echo "No port mappings found in any docker-compose.yml"; exit 1
          fi
